# 004.0-DEV-FILTER-VULNERABLE-VERSIONS: Filter Out Vulnerable Versions

## Release Goal

**Release 0.3: Security Intelligence**

Check the filtered mature versions for vulnerabilities and eliminate vulnerable ones. Smart checking: start from the newest mature version and work backwards until finding a safe one.

## How This Story Contributes

Completes the smart filtering by adding security to maturity. Now we recommend the newest mature version that has no known vulnerabilities.

## User Story

**Format**: So that I only update to safe, non-vulnerable versions, as a developer, I want dry-aged-deps to check mature versions for security vulnerabilities and filter out vulnerable ones.

**INVEST Criteria Compliance**:

- **Independent**: Builds on mature version filtering
- **Negotiable**: Vulnerability severity threshold could be configurable
- **Valuable**: Ensures security alongside maturity
- **Estimable**: Clear scope - check and filter
- **Small**: Single iteration
- **Testable**: Can verify vulnerability filtering

## Acceptance Criteria

- [ ] **Core Functionality**: Checks mature versions for known vulnerabilities
- [ ] **Smart Checking**: Checks newest mature first, works backwards until finding safe version
- [ ] **Eliminate Vulnerable**: Removes versions with known vulnerabilities from recommendations
- [ ] **Final Output**: Shows npm outdated style output with safe, mature updates only
- [ ] **No Safe Version**: Clearly indicates when no safe mature version exists

## Requirements (Current Implementation or To Be Implemented)

- **REQ-AUDIT-CHECK**: Use `npm audit` or registry API to check for vulnerabilities
- **REQ-SMART-SEARCH**: Check newest mature version first, work backwards
- **REQ-SAFE-ONLY**: Only recommend versions with no known vulnerabilities
- **REQ-CLEAR-OUTPUT**: Show final filtered results in npm outdated format

## Dependencies

- **003.0-DEV-FILTER-MATURE-VERSIONS**: Need mature versions to check

## Implementation Notes

**Smart Vulnerability Checking**:
```javascript
// For each package with mature versions
const matureVersions = getMatureVersions(package);
matureVersions.sort(semverDescending); // Newest first

for (const version of matureVersions) {
  const vulns = checkVulnerabilities(package, version);
  if (vulns.length === 0) {
    return version; // Found the newest safe mature version
  }
}
return null; // No safe mature versions available
```

**Vulnerability Check**:
```bash
# Check specific version
npm audit --package-lock-only
# Or use registry API
```

**Output Example**:
```
Package    Current    Safe Update    Age        Security
express    4.17.1     4.18.2         45 days    ✓ No vulnerabilities  
lodash     4.17.20    4.17.20        (stay)     Latest mature has vulns
```

**Testing Strategy**:
- Test with packages with no vulnerabilities
- Test with packages with vulnerabilities in latest
- Mock vulnerability data for tests

## Story Notes

**Gall's Law Compliance**: Adds final security filter to the working mature version filter.

**MVP Complete**: With stories 001-004, we have a complete safe updater that shows npm outdated style output filtered for maturity AND security.

## Release Goal

**Release 0.2: Smart Assessment - ASSESS Phase**

This story begins the ASSESS phase by adding the ability to calculate how long ago each package version was published. This is the foundational capability that enables maturity-based filtering.

## How This Story Contributes

This is the critical differentiator that makes dry-aged-deps different from `npm outdated`. By calculating package age, we enable the 7-day maturity rule that protects against supply chain attacks and rushed releases. This is the first step in smart version selection.

## User Story

**Format**: So that I can determine if a package version is mature enough to be safe, as a developer, I want dry-aged-deps to calculate and display how many days ago each available version was published.

**INVEST Criteria Compliance**:

- **Independent**: Builds on version fetching but adds independent age calculation
- **Negotiable**: Age display format and threshold warnings can be refined
- **Valuable**: Enables visibility into package freshness and maturity
- **Estimable**: Clear scope - date arithmetic and display
- **Small**: Can be completed in a single iteration
- **Testable**: Can verify age calculations are accurate

## Acceptance Criteria

- [ ] **Core Functionality**: Calculates days since publication for each version
- [ ] **Current Time**: Uses current date/time for accurate age calculation
- [ ] **Display Age**: Shows age in human-readable format (e.g., "3 days ago", "2 months ago")
- [ ] **Latest Version Age**: Prominently displays age of the latest available version
- [ ] **Freshness Warning**: Highlights versions that are less than 7 days old
- [ ] **Timezone Handling**: Correctly handles timezone differences
- [ ] **Future Dates**: Handles clock skew gracefully (packages published "in the future")

## Requirements (Current Implementation or To Be Implemented)

- **REQ-DATE-SOURCE**: Use publish timestamps from npm registry (from story 002.0)
- **REQ-AGE-CALC**: Calculate age as `current_date - publish_date`
- **REQ-UNIT-DISPLAY**: Show age in most appropriate unit (days, weeks, months, years)
- **REQ-FRESH-THRESHOLD**: Mark packages < 7 days old as "FRESH" or similar indicator
- **REQ-MATURE-THRESHOLD**: Mark packages >= 7 days old as "MATURE" or similar indicator
- **REQ-COLOR-CODING**: Use visual indicators for freshness (e.g., red=fresh, green=mature)
- **REQ-PRECISION**: Calculate to day-level precision (not hours/minutes)

## Dependencies

- **002.0-DEV-FETCH-AVAILABLE-VERSIONS**: Must have publish dates for each version

## Implementation Notes

**Technical Considerations**:
- Use JavaScript Date objects or date library (e.g., date-fns)
- Handle timezone conversion properly (npm times are in UTC)
- Calculate age in days: `Math.floor((now - publishDate) / (1000 * 60 * 60 * 24))`
- Consider using relative time formatting for better UX

**Age Display Logic**:
```javascript
// Pseudo-code
const ageInDays = calculateDaysSince(publishDate);

if (ageInDays < 1) return "Today";
if (ageInDays === 1) return "Yesterday";
if (ageInDays < 7) return `${ageInDays} days ago (FRESH)`;
if (ageInDays < 30) return `${ageInDays} days ago`;
if (ageInDays < 365) return `${Math.floor(ageInDays / 30)} months ago`;
return `${Math.floor(ageInDays / 365)} years ago`;
```

**Display Format**:
```
Package           Current    Latest     Age          Status
express           4.17.1     4.18.2     45 days      MATURE ✓
lodash            4.17.20    4.17.21    3 days       FRESH ⚠
react             17.0.2     18.2.0     156 days     MATURE ✓
```

**Testing Strategy**:
- Test with packages of various ages (hours, days, weeks, months, years)
- Test with current date/time mocking for consistency
- Test timezone handling
- Test edge cases (published today, published years ago)
- Test display formatting for all age ranges

**Security Considerations**:
- Validate date formats from registry
- Handle invalid or missing publish dates gracefully

## Definition of Done

- [ ] All acceptance criteria met
- [ ] Code reviewed and approved
- [ ] Unit tests for age calculation with mocked dates
- [ ] Tests for all age ranges (days, weeks, months, years)
- [ ] Timezone handling tested
- [ ] Visual indicators tested in terminal output
- [ ] Documentation explains age calculation and display
- [ ] CLI output clearly shows package maturity status

---

## Story Notes

**Gall's Law Compliance**: Adds one new dimension (age) to the existing working system without changing core discovery functionality. Users can still see outdated packages, but now also see if updates are mature.

**Next Evolution**: Story 005.0 will use this age data to filter out fresh packages and recommend only mature versions.

**Value Proposition**: This story starts delivering on the core promise of dry-aged-deps - making users aware of package freshness before they update.
