#!/usr/bin/env sh
. "$(dirname "$0")/_/husky.sh"

# Lint commit messages
npx --no-install commitlint --from=HEAD~1 --to=HEAD

# Lockfile drift check
npm install --package-lock-only --legacy-peer-deps
git diff --exit-code

# Lint code
npm run lint

# Type checking
npm run type-check

# Check formatting
npx prettier --check .

# Run unit tests
npm test

# Detect duplicate code
npx jscpd --threshold 20 src

# Prepare CLI fixture dependencies
npm install --ignore-scripts --no-audit --no-fund --legacy-peer-deps --prefix test/fixtures

# Prepare up-to-date CLI fixture dependencies
npm install --ignore-scripts --no-audit --no-fund --legacy-peer-deps --prefix test/fixtures-up-to-date

# Run CLI tests
npm run test:cli

# Run E2E CLI tests
npm run test:cli -- test/cli.e2e.real-fixture.test.js

# Ensure no repository changes post tests
git diff --exit-code

# Validate CLI version matches package.json
expected=$(npm pkg get version | tr -d '"')
actual=$(npx dry-aged-deps --version)
if [ "$actual" != "$expected" ]; then
  echo "CLI version $actual does not match package.json version $expected"
  exit 1
fi

# Vulnerability scan
npm audit --audit-level=moderate

exit 0