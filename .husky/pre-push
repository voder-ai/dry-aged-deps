#!/usr/bin/env sh
. "$(dirname "$0")/_/husky.sh"
npx --no-install commitlint --from=HEAD~1 --to=HEAD

# Local CodeQL SAST analysis
if command -v codeql >/dev/null 2>&1; then
  echo "Running local CodeQL SAST analysis..."
  codeql database create codeql-db --language=javascript --source-root=. --overwrite
  codeql database analyze codeql-db --format=terse
else
  echo "CodeQL CLI not found, skipping local SAST analysis"
fi

npm run lint
npm run type-check
npx prettier --check .
npm test

# Additional CI parity checks
npm install --package-lock-only --legacy-peer-deps --ignore-scripts
git diff --exit-code
npx jscpd --threshold 20 src
npm run test:cli
npm run test:cli -- test/cli.e2e.real-fixture.test.js
npm audit --audit-level=moderate