# 004.0-DEV-FILTER-VULNERABLE-VERSIONS: Filter Out Vulnerable Versions

## Release Goal

**Release 0.3: Security Intelligence**

Check the filtered mature versions for vulnerabilities and eliminate vulnerable ones. Smart checking: start from the newest mature version and work backwards until finding a safe one.

## How This Story Contributes

Completes the smart filtering by adding security to maturity. Now we recommend the newest mature version that has no known vulnerabilities.

## User Story

**Format**: So that I only update to safe, non-vulnerable versions, as a developer, I want dry-aged-deps to check mature versions for security vulnerabilities and filter out vulnerable ones.

**INVEST Criteria Compliance**:

- **Independent**: Builds on mature version filtering
- **Negotiable**: Vulnerability severity threshold could be configurable
- **Valuable**: Ensures security alongside maturity
- **Estimable**: Clear scope - check and filter
- **Small**: Single iteration
- **Testable**: Can verify vulnerability filtering

## Acceptance Criteria

- [ ] **Core Functionality**: Checks mature versions for known vulnerabilities (direct and transitive dependencies)
- [ ] **Transitive Dependencies**: Detects vulnerabilities in the entire dependency tree, not just the direct package
- [ ] **Smart Checking**: Checks newest mature first, works backwards until finding safe version
- [ ] **Eliminate Vulnerable**: Removes versions with known vulnerabilities from recommendations
- [ ] **Final Output**: Shows npm outdated style output with safe, mature updates only
- [ ] **No Safe Version**: Clearly indicates when no safe mature version exists

## Requirements (Current Implementation or To Be Implemented)

- **REQ-AUDIT-CHECK**: Use `npm audit` or registry API to check for vulnerabilities
- **REQ-TRANSITIVE-DEPS**: Check the entire dependency tree (direct and transitive dependencies) for vulnerabilities
- **REQ-SMART-SEARCH**: Check newest mature version first, work backwards
- **REQ-SAFE-ONLY**: Only recommend versions with no known vulnerabilities in the entire dependency chain
- **REQ-CLEAR-OUTPUT**: Show final filtered results in npm outdated format

## Dependencies

- **003.0-DEV-FILTER-MATURE-VERSIONS**: Need mature versions to check

## Implementation Notes

**Smart Vulnerability Checking**:

```javascript
// For each package with mature versions
const matureVersions = getMatureVersions(package);
matureVersions.sort(semverDescending); // Newest first

for (const version of matureVersions) {
  // Check both direct package AND its entire dependency tree
  const vulns = checkVulnerabilities(package, version);
  if (vulns.length === 0) {
    return version; // Found the newest safe mature version (no vulns in dep tree)
  }
}
return null; // No safe mature versions available
```

**Vulnerability Check**:

```bash
# Check specific version including transitive dependencies
# Create temporary package.json with the specific version
# Run npm audit to check entire dependency tree
npm audit --package-lock-only

# Example: For @semantic-release/npm@13.1.1
# This would detect vulnerabilities in tar@7.5.1 (transitive dependency)
```

**Output Example**:

```
Package    Current    Safe Update    Age        Security
express    4.17.1     4.18.2         45 days    ✓ No vulnerabilities
lodash     4.17.20    4.17.20        (stay)     Latest mature has vulns
```

**Testing Strategy**:

- Test with packages with no vulnerabilities (direct or transitive)
- Test with packages with vulnerabilities in latest version
- Test with packages with vulnerabilities in transitive dependencies (e.g., @semantic-release/npm@13.1.1 → tar@7.5.1)
- Test that safe older versions are recommended when latest has transitive vulnerabilities
- Mock vulnerability data for tests

## Story Notes

**Gall's Law Compliance**: Adds final security filter to the working mature version filter.

**MVP Complete**: With stories 001-004, we have a complete safe updater that shows npm outdated style output filtered for maturity AND security.

**Transitive Dependency Example**: The vulnerability in `@semantic-release/npm@13.1.1` (via `tar@7.5.1`) demonstrates why checking the entire dependency tree is critical. A package may appear safe directly but contain vulnerable transitive dependencies.
