# 001.1-SDLC-CI-PUBLISH: CI/CD publishing setup

## Release Goal

**Minimum Viable Publishing: Automated CI/CD publishing**

Enable publishing to npm registry only from CI/CD pipeline. No developer machines should ever publish directly - this ensures consistency, security, and traceability.

## How This Story Contributes

Establishes secure, automated publishing workflow from the start. Prevents security issues, ensures consistent builds, and provides audit trail of all releases.

## User Story

**Format**: So that I can safely publish releases without manual intervention, as a developer, I want CI/CD to automatically publish to npm when I create a release tag.

**INVEST Criteria Compliance**:

- **Independent**: Can work with basic GitHub Actions and npm tokens
- **Negotiable**: Can use different CI systems, trigger mechanisms
- **Valuable**: Enables secure, traceable publishing
- **Estimable**: Clear scope - GitHub Actions + npm publish
- **Small**: Can be completed in single session
- **Testable**: Success = CI publishes to npm on tag creation

## Acceptance Criteria

- [ ] **QA Gates**: All linting, unit tests, CLI tests, and coverage checks must pass
- [ ] **GitHub Actions Workflow**: CI runs on tag creation (git tag)
- [ ] **npm Authentication**: CI authenticates securely with npm using secrets
- [ ] **Automated Publishing**: CI runs `npm publish` only after all QA gates pass
- [ ] **Pipeline Monitoring**: Use `gh run watch` to monitor workflow execution in real-time
- [ ] **Error Handling**: Use `gh run view --log` to troubleshoot any pipeline failures
- [ ] **Security**: No manual publishing allowed, only from CI
- [ ] **Traceability**: All releases traceable to specific commits/tags

## Requirements (Current Implementation or To Be Implemented)

- **REQ-CI-WORKFLOW**: GitHub Actions workflow for publishing
- **REQ-NPM-TOKEN**: npm authentication token stored as GitHub secret
- **REQ-TAG-TRIGGER**: Publishing triggered by git tag creation only

## Dependencies

- Story 001.0 (basic package.json and CLI functionality)
- Story 001.3 (linting setup for CI linting step)
- Story 002.1 (test setup for CI testing step)
- Story 002.2 (CLI testing for CI integration testing)
- npm account and authentication token
- GitHub repository with Actions enabled

## Implementation Notes

**Technical Considerations**:

- Use GitHub Actions for CI/CD (free for public repos)
- Store npm token as GitHub secret (NPM_TOKEN)
- Trigger on tag creation to control releases
- Ensure package.json version matches tag

**GitHub Actions Workflow** (`.github/workflows/publish.yml`):

```yaml
name: Publish to npm

on:
  push:
    tags:
      - 'v*'

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        run: npm ci

      - name: Run linting
        run: npm run lint

      - name: Run unit tests
        run: npm test

      - name: Run CLI integration tests
        run: npm run test:cli

      - name: Check code coverage
        run: npm run test:coverage

      - name: Publish to npm
        run: npm publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
```

**Release Process**:

1. Update version in package.json
2. Commit changes
3. Create git tag: `git tag v0.1.0`
4. Push tag: `git push origin v0.1.0`
5. **Monitor CI Pipeline**: Use `gh run watch` to monitor the workflow in real-time
6. CI automatically publishes to npm (if all checks pass)

**Pipeline Monitoring with GitHub CLI**:

```bash
# Watch the current workflow run in real-time
gh run watch

# List recent workflow runs to see status
gh run list --workflow=publish.yml

# View logs for a specific run if there are failures
gh run view [RUN_ID] --log

# Quickly check if the last run succeeded
gh run list --limit=1
```

**Troubleshooting Failed Runs**:

- Use `gh run view --log` to see detailed error messages
- Common issues: npm token expiration, test failures, version mismatches
- Re-run failed jobs: `gh run rerun [RUN_ID]`
- Fix issues and create new tag if fundamental problems exist

**Security Setup**:

- npm token stored as GitHub secret (Settings > Secrets > NPM_TOKEN)
- No developer machines have npm credentials
- All publishes are auditable via GitHub Actions logs

**Testing Strategy**:

- Test workflow with dry-run first
- Test with scoped package name initially
- **Monitor with GitHub CLI**: Use `gh run watch` during test runs to catch issues early
- **Debug failures immediately**: Use `gh run view --log` to troubleshoot any problems
- Verify package appears correctly on npm registry
- Document common failure scenarios and fixes

## Definition of Done

- [ ] All acceptance criteria met
- [ ] GitHub Actions workflow created and tested
- [ ] npm token configured as GitHub secret
- [ ] Package successfully published via CI
- [ ] Release process documented for team
- [ ] No manual publishing capability exists

---

## Story Notes

**Security First**: Publishing only from CI/CD prevents credential exposure and ensures consistent, auditable releases.

**Simple Trigger**: Tag-based publishing is simple and provides clear release points.

**Next Evolution**: Story 003.0 can add semantic versioning automation to eliminate manual version management.
