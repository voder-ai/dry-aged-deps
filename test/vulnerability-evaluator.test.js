/**
 * @story prompts/dry-aged-deps-user-story-map.md
 *//**
 * @story prompts/dry-aged-deps-user-story-map.md
 *//**
 * Tests for evaluateVersionVulnerabilities functionality
 * @story prompts/004.0-DEV-FILTER-VULNERABLE-VERSIONS.md
 * @req REQ-SAFE-ONLY - Evaluate safe-only vulnerability filtering
 */
import { describe, it, expect } from 'vitest';
import { evaluateVersionVulnerabilities } from '../src/vulnerability-evaluator.js';

const severityWeights = { none: 0, low: 1, moderate: 2, high: 3, critical: 4 };

describe('evaluateVersionVulnerabilities - numeric result path', () => {
  it('returns safe=true when checkVulnerabilities returns 0', async () => {
    const checkVuln = async () => 0;
    const result = await evaluateVersionVulnerabilities('pkg', '1.0.0', checkVuln, 'low', severityWeights);
    expect(result).toEqual({ safe: true, totalCount: 0, maxSeverity: 'none', detailsList: [] });
  });

  it('returns safe=false and correct maxSeverity when count > 0', async () => {
    const checkVuln = async () => 3;
    const result = await evaluateVersionVulnerabilities('pkg', '1.0.0', checkVuln, 'moderate', severityWeights);
    expect(result.safe).toBe(false);
    expect(result.totalCount).toBe(3);
    expect(result.maxSeverity).toBe('moderate');
    expect(result.detailsList).toEqual([]);
  });

  it('catches errors from checkVulnerabilities and marks safe=false', async () => {
    const checkVuln = async () => {
      throw new Error('fail');
    };
    const result = await evaluateVersionVulnerabilities('pkg', '1.0.0', checkVuln, 'none', severityWeights);
    expect(result.safe).toBe(false);
  });
});

describe('evaluateVersionVulnerabilities - object result path', () => {
  const details = [
    { name: 'v1', severity: 'low' },
    { name: 'v2', severity: 'high' },
    { name: 'v3', severity: 'none' },
  ];
  it('computes totalCount and maxSeverity from object details', async () => {
    const resultObj = { count: 3, details };
    const checkVuln = async () => resultObj;
    const res = await evaluateVersionVulnerabilities('pkg', '1.0.0', checkVuln, 'low', severityWeights);
    expect(res.totalCount).toBe(3);
    expect(res.detailsList).toEqual(details);
    expect(res.maxSeverity).toBe('high');
    expect(res.safe).toBe(false);
  });

  it('infers count from details length when count missing', async () => {
    const checkVuln = async () => ({ details });
    const res = await evaluateVersionVulnerabilities('pkg', '1.0.0', checkVuln, 'none', severityWeights);
    expect(res.totalCount).toBe(details.length);
    expect(res.safe).toBe(false);
  });

  it('returns safe=true when no detail >= threshold', async () => {
    const checkVuln = async () => ({ count: details.length, details });
    const res = await evaluateVersionVulnerabilities('pkg', '1.0.0', checkVuln, 'critical', severityWeights);
    expect(res.safe).toBe(true);
  });
});

describe('evaluateVersionVulnerabilities - object without details', () => {
  it('handles object with count but no details array', async () => {
    const resultObj = { count: 2 };
    const checkVuln = async () => resultObj;
    const res = await evaluateVersionVulnerabilities('pkg', '1.0.0', checkVuln, 'none', severityWeights);
    expect(res.totalCount).toBe(2);
    expect(res.detailsList).toEqual([]);
    expect(res.maxSeverity).toBe('none');
    expect(res.safe).toBe(true);
  });
});

describe('evaluateVersionVulnerabilities - catch path full result', () => {
  it('returns default values when checkVulnerabilities throws error', async () => {
    const checkVuln = async () => {
      throw new Error('error-fetch');
    };
    const res = await evaluateVersionVulnerabilities('pkg', '1.0.0', checkVuln, 'high', severityWeights);
    expect(res).toEqual({ safe: false, totalCount: 0, maxSeverity: 'none', detailsList: [] });
  });
});
