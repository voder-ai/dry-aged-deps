/**
 * @story prompts/dry-aged-deps-user-story-map.md
 * @req UNKNOWN - Placeholder traceability annotation
 */

import { describe, it, expect } from 'vitest';
import { xmlFormatter } from '../src/xml-formatter.js';

describe('xmlFormatter object row without vulnerability details', () => {
  it('should render <vulnerabilities> with <details> but no <vulnerability> children when details missing', () => {
    const rows = [
      {
        name: 'pkgY',
        current: '1.0.0',
        wanted: '1.1.0',
        latest: '1.1.0',
        age: 12,
        recommended: '1.1.0',
        vulnerabilities: {
          count: 1,
          maxSeverity: 'low',
          // details missing
        },
        filtered: false,
        filterReason: '',
        dependencyType: 'dev',
      },
    ];
    const summary = {
      totalOutdated: 1,
      safeUpdates: 1,
      filteredByAge: 0,
      filteredBySecurity: 0,
    };
    const timestamp = '2025-07-07T07:07:07Z';
    const xml = xmlFormatter({ rows, summary, timestamp });

    // Basic vulnerabilities section
    expect(xml).toContain('<vulnerabilities>');
    expect(xml).toContain('<count>1</count>');
    expect(xml).toContain('<max-severity>low</max-severity>');

    // Should have <details> tags but no <vulnerability> entries
    const detailsMatch = xml.match(/<details>[\s\S]*?<\/details>/);
    expect(detailsMatch).not.toBeNull();
    const detailsSection = detailsMatch[0];
    expect(detailsSection).not.toContain('<vulnerability>');
  });
});
