/* eslint-disable traceability/valid-story-reference, traceability/valid-req-reference, traceability/valid-annotation-format, traceability/prefer-supports-annotation */
// @ts-check
/* eslint-disable traceability/valid-story-reference, traceability/valid-annotation-format, traceability/prefer-supports-annotation, traceability/require-story-annotation, traceability/require-req-annotation */
import { computeVulnerabilityStats, countAboveThreshold } from './security-helpers.js';
/**
 * Evaluate vulnerability result for a specific package version.
 * @supports prompts/004.0-DEV-FILTER-VULNERABLE-VERSIONS.md REQ-SAFE-ONLY
 * @param {string} name - Package name.
 * @param {string} version - Package version to evaluate.
 * @param {function(string, string): Promise<number|object>} checkVulnerabilities - Async function(name, version) returning number or details object.
 * @param {string} minSeverity - Minimum allowed severity for this dependency.
 * @param {{ [key: string]: number }} severityWeights - Mapping of severity labels to weight.
 * @returns {Promise<{ safe: boolean, totalCount: number, maxSeverity: string, detailsList: Array<any> }>} Evaluation result.
 */
/** @story docs/stories/003.0-DEV-FUNCTION-ANNOTATIONS.story.md */
export async function evaluateVersionVulnerabilities(
  name,
  version,
  checkVulnerabilities,
  minSeverity,
  severityWeights
) {
  // @trace entry: evaluateVersionVulnerabilities
  let safe = true;
  let totalCount = 0;
  let detailsList = [];
  let maxSeverity = 'none';

  const weightMap = new Map(Object.entries(severityWeights));
  const minWeight = weightMap.get(minSeverity) ?? 0;

  // @supports prompts/004.0-DEV-FILTER-VULNERABLE-VERSIONS.md REQ-SAFE-ONLY
  try {
    const result = await checkVulnerabilities(name, version);

    // @supports prompts/004.0-DEV-FILTER-VULNERABLE-VERSIONS.md REQ-SAFE-ONLY
    if (typeof result === 'number') {
      totalCount = result;
      detailsList = [];
      maxSeverity = totalCount > 0 ? minSeverity : 'none';
      safe = totalCount === 0;
      // @supports prompts/004.0-DEV-FILTER-VULNERABLE-VERSIONS.md REQ-SAFE-ONLY
    } else if (result && typeof result === 'object') {
      const stats = computeVulnerabilityStats(result, severityWeights);
      totalCount = stats.totalCount;
      maxSeverity = stats.maxSeverity;
      detailsList = stats.detailsList;
      const aboveThresholdCount = countAboveThreshold(detailsList, minWeight, severityWeights);
      safe = aboveThresholdCount === 0;
      // @supports prompts/004.0-DEV-FILTER-VULNERABLE-VERSIONS.md REQ-SAFE-ONLY
    }
    // @supports prompts/004.0-DEV-FILTER-VULNERABLE-VERSIONS.md REQ-SAFE-ONLY
  } catch {
    // @req REQ-SAFE-ONLY
    // @story <story-file>.story.md
    safe = false;
    // @supports prompts/004.0-DEV-FILTER-VULNERABLE-VERSIONS.md REQ-SAFE-ONLY
  }

  return { safe, totalCount, maxSeverity, detailsList };
}
