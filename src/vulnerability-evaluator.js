/* eslint-disable traceability/valid-annotation-format */
// @ts-check
import { computeVulnerabilityStats, countAboveThreshold } from './security-helpers.js';
/**
 * Evaluate vulnerability result for a specific package version.
 * @story prompts/004.0-DEV-FILTER-VULNERABLE-VERSIONS.md
 * @req REQ-SAFE-ONLY - Determine if a given package version is safe based on severity thresholds.
 * @param {string} name - Package name.
 * @param {string} version - Package version to evaluate.
 * @param {function(string, string): Promise<number|object>} checkVulnerabilities - Async function(name, version) returning number or details object.
 * @param {string} minSeverity - Minimum allowed severity for this dependency.
 * @param {{ [key: string]: number }} severityWeights - Mapping of severity labels to weight.
 * @returns {Promise<{ safe: boolean, totalCount: number, maxSeverity: string, detailsList: Array<any> }>} Evaluation result.
 */
export async function evaluateVersionVulnerabilities(
  name,
  version,
  checkVulnerabilities,
  minSeverity,
  severityWeights
) {
  // @trace entry: evaluateVersionVulnerabilities
  let safe = true;
  let totalCount = 0;
  let detailsList = [];
  let maxSeverity = 'none';

  const weightMap = new Map(Object.entries(severityWeights));
  const minWeight = weightMap.get(minSeverity) ?? 0;

  try {
    const result = await checkVulnerabilities(name, version);

    /* @trace branch: primitive-number-result */
    if (typeof result === 'number') {
      totalCount = result;
      detailsList = [];
      maxSeverity = totalCount > 0 ? minSeverity : 'none';
      safe = totalCount === 0;
    } else if (result && typeof result === 'object') {
      /* @trace branch: object-result */
      const stats = computeVulnerabilityStats(result, severityWeights);
      totalCount = stats.totalCount;
      maxSeverity = stats.maxSeverity;
      detailsList = stats.detailsList;
      const aboveThresholdCount = countAboveThreshold(detailsList, minWeight, severityWeights);
      safe = aboveThresholdCount === 0;
    }
  } catch {
    /* @trace branch: exception */
    safe = false;
  }

  return { safe, totalCount, maxSeverity, detailsList };
}
