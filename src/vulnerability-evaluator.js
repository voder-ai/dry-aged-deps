// @ts-nocheck
/* eslint-disable security/detect-object-injection */
/**
 * Evaluate vulnerability result for a specific package version.
 * @story prompts/004.0-DEV-FILTER-VULNERABLE-VERSIONS.md
 * @req REQ-SAFE-ONLY - Determine if a given package version is safe based on severity thresholds.
 * @param {string} name - Package name.
 * @param {string} version - Package version to evaluate.
 * @param {function} checkVulnerabilities - Async function(name, version) returning number or details object.
 * @param {string} minSeverity - Minimum allowed severity for this dependency.
 * @param {{ [key: string]: number }} severityWeights - Mapping of severity labels to weight.
 * @returns {Promise<{ safe: boolean, totalCount: number, maxSeverity: string, detailsList: Array }>} Evaluation result.
 */
export async function evaluateVersionVulnerabilities(
  name,
  version,
  checkVulnerabilities,
  minSeverity,
  severityWeights
) {
  const minWeight = severityWeights[minSeverity] || 0;
  let safe = true;
  let totalCount = 0;
  let detailsList = [];
  let maxSeverity = 'none';
  try {
    const result = await checkVulnerabilities(name, version);
    if (typeof result === 'number') {
      totalCount = result;
      detailsList = [];
      maxSeverity = totalCount > 0 ? minSeverity : 'none';
      safe = totalCount === 0;
    } else if (result && typeof result === 'object') {
      totalCount =
        typeof result.count === 'number' ? result.count : Array.isArray(result.details) ? result.details.length : 0;
      detailsList = Array.isArray(result.details) ? result.details : [];
      let highestWeight = 0;
      for (const vuln of detailsList) {
        const weight = severityWeights[(vuln.severity || '').toLowerCase()] || 0;
        if (weight > highestWeight) highestWeight = weight;
      }
      maxSeverity = Object.keys(severityWeights).find((k) => severityWeights[k] === highestWeight) || 'none';
      const aboveThresholdCount = detailsList.filter(
        (v) => (severityWeights[(v.severity || '').toLowerCase()] || 0) >= minWeight
      ).length;
      safe = aboveThresholdCount === 0;
    }
  } catch {
    safe = false;
  }

  return { safe, totalCount, maxSeverity, detailsList };
}
